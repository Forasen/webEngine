微型机与应用
MICROCOMPUTER & ITS APPLICATIONS
2000 Vol.19 No.3 P.33-34,40



分布式容错时间同步化系统的误差分析
欧阳珣　李榕　方维坚
　　摘　要：分布式容错时间同步化系统是为了解决分布式环境中的各种计算机同步问题的一种工具。但是由于在时间同步上存在着很多误差,大大地影响了时间同步化的精度。本文较为详细地分析了误差产生的主要原因,并且根据实验提出了解决误差问题的建议和方法。
　　关键词：分布式 容错 时间同步化系统 误差分析
1 分布式容错时间同步策略简介
　　目前,有许多的应用领域需要依靠电脑的高可靠性和高效率来精确掌握关键性的工作与任务,例如航管系统、医疗监视系统以及核能发电系统等等。这类系统无法容许任何的错误产生。以往传统的设计与要求,已不适合在如此严格的环境下运作,因此,如何精确地掌握错误模式与影响程度是一个相当重要的问题。
　　随着计算机网络技术的发展与主从结构（client/server）观念的提倡,比中央集权式（centralized processing）更有弹性、成本更低的分布式处理结构（distributed processing）已为现今众多系统所采用。“分布式系统容错”（fault tolerance in distributed systems）就是探讨容错技术在分布式系统中的应用。随着网络技术的发展,单机单工系统日益减少,取而代之的是多机多工的分布式电脑系统。分布式系统中主要的元件如:处理器、通信网络、计时器、资料储存装置及软件等,这些都是单一独立的元件,并且这些典型的元件通常不会考虑容错。但事实上,在分布式系统中,这些元件都是以相互合作的方式在运作,不可能脱离其它元件而独立,因而这些元件的容错能力决定了分布式系统容错能力,是分布式系统容错主要的研究范畴。而“时间同步化”正是分布式系统容错中相当重要的课题。
　　在目前的分布式系统的时间同步上存在着技术上的困难与限制:1.无法达成真正的时间同步化。因为在分布式环境中,每个节点都有自己的计时器,而每个计时器的进行速率不可能全部一致,很难达成所有系统节点时间上的绝对同步;2.分布式系统中的时间同步化往往要参考其它节点的时间来进行修正,而要取得参考时间的资料,必须要通过通信网络的传递。实际通信网络的信息传递一定会有时间上的延迟（propagation delay）;3.参考时间在分布式环境中传输的正确性也会严重影响系统时间同步。
分布式容错的时间同步化策略与算法相当多,基本上可分为以下三大类型。
1.1 主仆式及时间服务器的时间同步化策略
　　主仆式及时间服务器时间同步化策略在分布系统中,是最直接、最简单也是最广泛被应用于分布式系统中达到时间同步化的方法。其策略就是在系统中建立1个或若干个具有高可信度与有效度的时间服务器,而系统中其它的节点则透过通信网络与服务器直接地撷取正确的时间来修正各自的时间,进而达到整个系统中各节点时间上的同步。
　　主仆式时间同步化策略最主要的应用是NTP（Network Time Protocol）及其相关的SNTP（Simple NTP）的制定,且成为当今国际网络中许多时间同步化机制的标准。另外运用时间服务器式的时间同步化策略的关键Novell Netware 4.01网管系统也是采用的主仆式结构。Netware 4.01将其系统区分为内部时间同步化（internal time synchronization）与外部时间同步化（external time synchronization）,主要是建立几种不同类型的时间服务器,依其不同的功能而分层管理,如图1所示。主仆式与时间服务器式时间同步化策略的优点是其原理和设备都很简单,但缺点是容错能力低、集中式管理易受瓶颈效应（bottle-neck effect）影响等。

图1 Netware 4.01时间服务器
1.2 拜占庭协议式时间同步化策略
　　拜占庭协议（Byzantine Agreement/Consensus）在分布式系统容错领域中是另一种基本且重要的容错技术,它的算法就是其中一节点充当发送者,由它发送一特定信息给所有结点,非错误节点接收到此信息一经处理后,会将它再正确地广播给其它剩余节点,每个节点透过彼此信息的交换,通过多数决定（majority）方式可以知道哪些节点发生错误,之后各节点再轮流当发送者,不断传递回交换信息,直至所有错误被找到为止,如图2所示。

图2 拜占庭协议示意图
　　拜占庭协议具有如下特性:（1）它适用于侦测所有分布式系统中的任何错误（arbitrary fault）,包括信息遗失或节点错误等等;（2）它要执行m次递归程序以决定m个错误;（3）它的容错能力可以达总节点数三分之一的错误个数,每个节点对外连接数需大于错误个数2倍。
　　拜占庭协议也被用于时间同步化的策略上,其优点:（1）容错能力强;（2）适用于任何形态的系统错误。缺点:（1）它需要相当多的信息交换量来达到,这会加重整个网络负载;（2）它适用于特定信息的交换,对于时间同步化中需交换非特定的参考时间信息,存在应用上的限制。
1.3 收敛函数式时间同步化策略
　　收敛函数式时间同步化策略是分布式容错时间同步算法研究中第3种被广泛使用的一种策略。其目的是搜集系统中各个节点的参考时间,通过1个有效的收敛函数从所收集的参考时间里决定同步化时间,再根据其结果来调整各自的时间。基本步骤如下:
　　1.从其它的节点收集参考时间值;
　　2.考虑影响因素进而估算其时间估计值;
　　3.运用一收敛函数计算这些时间估计值,并获得一正确时间值;
　　4.根据正确时间值来修正各自的时间。
2 分布式容错时间同步化系统的误差分析
　　我们课题小组设计了1个简单网络时间协议。根据设计,此协议要求达到的精度是0.5s,所设计的系统包括1台服务器和1个客户端,客户端向服务器发送时间同步的请求,服务器在收到了请求后将时间信息发送给客户端,从而达到时间的同步化。但是在实际的工作环境中,由于各个方面的原因,服务端和客户端不可能达到完全同步,这是因为在时间传输过程中存在着各种误差。
根据分布式容错时间同步化系统的精度公式:

　　式中:n为节点总数,k为出错的节点数。
　　在系统中产生误差的因素为Δmax和θmax,其中Δmax为时间信息延时最大值,θmax为时间估计值中间隔最大值,也就是最大时钟误差。在整个系统启动或新的客户端加入时,可能会因为θmax值大大地影响精确度,但是经过2次时间同步化的周期后,就可收敛至一定的数值。根据我们的实践经验,在同1个局域网络上,以3分钟时间为同步化周期,则θmax值介于28550ms,因此θmax的影响会趋于固定,变动性不大。
　　另1个影响时间同步化精确度的因素就是网络传输延迟Δmax。对所有的时间同步化策略而言,传输延迟都是非常重要的被考虑因素。我们认为分布式系统容错的时间同步化主要分为二大类:即决定论时间同步化和几率论时间同步化。它们二者之间最主要的差别就是网络传输的时间延迟Δ;另外经由实验得知,网络传输时间延迟越小,所得到的时间同步化结果精确度就越高。因此,网络传输的时间延迟在整个时间同步化的研究中具有举足轻重的作用,是不可忽略的。
　　根据系统的实验,误差产生最主要的原因还是因为网络传输时间延迟太大,影响了整个同步化结果的精确度。针对造成网络传输时间延迟过大的原因,经过研究和实验,得出影响网络传输延迟产生的原因和解决办法。
　　1.TCP/IP网络通信协定对网络传输延迟有影响。我们的SNTP系统是采用TCP/IP通信协议来作为网络通信的基础,虽然可以保证时间信息不遗失的重送（retransmission）机制,但增加了网络传输的时间延迟,造成Δmax过大,影响时间同步化结果的精度。
　　根据ISO所制定的ISO网络参考模型七层结构,SNTP系统属于应用层（application layer）间的网络通信,而TCP/IP是属于传输层（transport layer）的网络通信协定,我们认为造成网络传输时间延迟过大的最主要原因在于TCP/IP通信协定的通信协定延迟（Protocol delay）,造成Δmax估计值过大,如同在传输速度很慢的通信网络上进行时间同步化一样,互相传递交换的时间信息延迟自然变大,间接影响时间同步化的精度。
　　2.通信协定延迟的大小显示当时该机器的网络传输状态,影响的因素非常多,包括网络负载（network traffic load）与该机器处理程序的忙碌状态等。
　　针对上述2个影响网络传输产生延迟的原因,经过研究提出了下列解决办法:
　　（1）消除通信协定延迟的影响因素,即将整个时间同步化拉至传输层上进行,缩小信息传输的时间延迟,以接近真实的网络时间延迟,达到改善时间同步化的精确度,如图3所示。

图3 降低通信协定延迟示意图
　　然而消除通信协定延迟的影响并非那么容易,TCP/IP属于可靠性传输通信协定,它的传输时间是无法预测的,同样它的通信协定延迟也是无法预测的,此时刻的通信协定延迟无法代表或推测下一时刻的通信协定延迟,因此很难直接测试。但可以在进行时间同步化大量交换采集时间信息时,服务器端与客户端各自送个信息给本地主机（Local Host）,至传输层被传回来,如此可以测量当时服务器端与客户端的通信协定延迟总和。
　　（2）针对其它的影响因素,虽然可通过对当时的通信协定延迟进行测量,但无法代表在交换信息时所有信息的通信协定延迟,为此我们用最小参考值来代替,以期尽量接近当时的通信协定延迟。由于我们的SNTP系统主要是针对局域网络应用,根据之前进行程序测量的结果,最终可得局域网络的真正传输时间延迟小于10ms。假设真正网络传输时间延迟最大值为a,第i个客户端的通信协定延迟为Qci,服务器端通信协定延迟为Qs,因为α=（Qs+Qci）;也可取min（Qs+Qci）二者之中取较小者当作通信协定延迟的最小参考值,即选min（Qd,min（Qs+Qci））作为消除通信协定延迟的参考值。
　　由于各方面的原因,我们对于所提出的将时间同步化从应用层拉至传输层上进行的方法没有得到实验的证实,但是通过上面分析可以预知,与原来的信息传递方式相比,此方法可以大大地改善系统的延迟现象。
欧阳珣（武汉华中理工大学计算机学院430074）
李榕（武汉华中理工大学计算机学院430074）
方维坚（武汉华中理工大学计算机学院430074）
参考文献
1，Mills D.L.Algorithms for synchronizing network clocks.DARPA Network Working Group Report RFC-956,M/A-COM Linkabit,1985;(9)
2，Mills D.L.Network Time Protocol (version 2)-specifi-cation and implementation.DARPA Network Working Group Report RFC-1119.University of Delaware,
1989;(9)
3，David L.Mills,Simple Network Time Protocol (SNTP),network working group report RFC-1361,1992;(8)
4，Digital Time Service Functional Specification Ver-sion T.1.0.5.Digital Equipment Corporation,1989
5 Halpern J Y,Simons B,Strong R et al. FaultTolerant Clock Synchronization.Proc.Third Annual ACM Syn-posiumon Principles of Distributed computing.1984;(8)
6 周明天,汪文勇.TCP/IP网络原理与技术.北京:清华大学出版社,1993
收稿日期：1999-10-31
